generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                       String              @id @default(cuid())
  username                 String              @unique
  password                 String
  name                     String?
  image                    String?
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  accountLockedUntil       DateTime?
  createdBy                String?
  isActive                 Boolean             @default(true)
  lastLogin                DateTime?
  loginAttempts            Int                 @default(0)
  parentAgentId            String?
  tenantId                 String?
  userType                 String              @default("player")
  account                  Account?
  targetAuditLogs          AuditLog[]          @relation("TargetUser")
  auditLogs                AuditLog[]          @relation("UserActions")
  agentBalanceAdjustments  BalanceAdjustment[] @relation("AgentAdjustments")
  playerBalanceAdjustments BalanceAdjustment[] @relation("PlayerAdjustments")
  bets                     Bet[]
  agent                    User?               @relation("AgentPlayers", fields: [parentAgentId], references: [id])
  registeredPlayers        User[]              @relation("AgentPlayers")

  @@index([username])
  @@index([userType])
  @@index([tenantId])
  @@index([parentAgentId])
  @@index([isActive])
  @@map("users")
}

model Account {
  userId    String   @id
  balance   Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  freePlay  Float    @default(0)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Sport {
  id      String   @id
  name    String
  icon    String
  leagues League[]

  @@map("sports")
}

model League {
  id      String @id
  name    String
  sportId String
  logo    String
  games   Game[]
  sport   Sport  @relation(fields: [sportId], references: [id], onDelete: Cascade)

  @@index([sportId])
  @@map("leagues")
}

model Team {
  id        String   @id
  name      String
  shortName String
  logo      String
  record    String?
  leagueId  String?
  awayGames Game[]   @relation("AwayTeam")
  homeGames Game[]   @relation("HomeTeam")
  players   Player[]

  @@index([leagueId])
  @@map("teams")
}

model Game {
  id            String       @id
  leagueId      String
  homeTeamId    String
  awayTeamId    String
  startTime     DateTime
  status        String       @default("upcoming")
  venue         String?
  homeScore     Int?
  awayScore     Int?
  period        String?
  timeRemaining String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  finishedAt    DateTime?
  bets          Bet[]
  gameProps     GameProp[]
  awayTeam      Team         @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)
  homeTeam      Team         @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
  league        League       @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  odds          Odds[]
  playerProps   PlayerProp[]

  @@index([leagueId])
  @@index([status])
  @@index([startTime])
  @@index([leagueId, status, startTime])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([status, updatedAt])
  @@map("games")
}

model Odds {
  id          String   @id @default(cuid())
  gameId      String
  betType     String
  selection   String?
  odds        Int
  line        Float?
  lastUpdated DateTime @default(now())
  bookOdds    Int?
  fairOdds    Int?
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([betType])
  @@index([gameId, betType])
  @@map("odds")
}

model Bet {
  id              String    @id @default(cuid())
  userId          String
  gameId          String?
  betType         String
  selection       String
  odds            Int
  line            Float?
  stake           Float
  potentialPayout Float
  status          String    @default("pending")
  placedAt        DateTime  @default(now())
  settledAt       DateTime?
  legs            Json?
  idempotencyKey  String?   @unique
  teaserMetadata  Json?
  teaserType      String?
  actualResult    String?
  game            Game?     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([gameId])
  @@index([status])
  @@index([betType])
  @@index([userId, status, placedAt])
  @@index([status, gameId])
  @@index([status, settledAt])
  @@map("bets")
}

model Player {
  id           String       @id
  name         String
  teamId       String
  position     String
  jerseyNumber String?
  playerProps  PlayerProp[]
  team         Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@map("players")
}

model PlayerProp {
  id          String   @id @default(cuid())
  gameId      String
  playerId    String
  statType    String
  line        Float
  overOdds    Int
  underOdds   Int
  category    String
  lastUpdated DateTime @default(now())
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  player      Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([playerId])
  @@index([gameId, playerId])
  @@map("player_props")
}

model GameProp {
  id          String   @id @default(cuid())
  gameId      String
  propType    String
  description String
  selection   String?
  odds        Int
  line        Float?
  lastUpdated DateTime @default(now())
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([propType])
  @@map("game_props")
}

model BalanceAdjustment {
  id              String   @id @default(cuid())
  tenantId        String?
  playerId        String
  agentId         String
  adjustmentType  String
  amount          Float
  previousBalance Float
  newBalance      Float
  reason          String?
  ipAddress       String?
  createdAt       DateTime @default(now())
  agent           User     @relation("AgentAdjustments", fields: [agentId], references: [id], onDelete: Cascade)
  player          User     @relation("PlayerAdjustments", fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([agentId])
  @@index([tenantId])
  @@index([createdAt])
  @@map("balance_adjustments")
}

model AuditLog {
  id           String   @id @default(cuid())
  tenantId     String?
  userId       String
  actionType   String
  targetUserId String?
  oldValue     String?
  newValue     String?
  ipAddress    String?
  userAgent    String?
  metadata     Json?
  createdAt    DateTime @default(now())
  targetUser   User?    @relation("TargetUser", fields: [targetUserId], references: [id])
  user         User     @relation("UserActions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([targetUserId])
  @@index([tenantId])
  @@index([actionType])
  @@index([createdAt])
  @@map("audit_logs")
}

model AdminUser {
  id                String              @id @default(cuid())
  username          String              @unique
  password          String
  role              String              @default("admin")
  status            String              @default("active")
  lastLogin         DateTime?
  loginAttempts     Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  activityLogs      AdminActivityLog[]
  agentsCreated     Agent[]
  oddsConfigHistory OddsConfigHistory[]
  oddsConfigs       OddsConfiguration[]

  @@index([username])
  @@index([status])
  @@index([role])
  @@map("admin_users")
}

model Agent {
  id                    String            @id @default(cuid())
  username              String            @unique
  displayName           String?
  password              String
  maxSingleAdjustment   Float             @default(1000)
  dailyAdjustmentLimit  Float             @default(5000)
  currentDailyTotal     Float             @default(0)
  lastDailyReset        DateTime          @default(now())
  canSuspendPlayers     Boolean           @default(true)
  commissionRate        Float?
  ipRestriction         String?
  regionAssignment      String?
  notes                 String?
  permissions           Json?
  status                String            @default("active")
  lastLogin             DateTime?
  createdBy             String
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  balanceAdjustmentsLog AgentBalanceLog[]
  creator               AdminUser         @relation(fields: [createdBy], references: [id])
  players               DashboardPlayer[]

  @@index([username])
  @@index([status])
  @@index([createdBy])
  @@index([lastDailyReset])
  @@map("agents")
}

model DashboardPlayer {
  id            String              @id @default(cuid())
  username      String              @unique
  displayName   String?
  password      String
  agentId       String?
  balance       Float               @default(0)
  bettingLimits Json?
  status        String              @default("active")
  totalBets     Int                 @default(0)
  totalWagered  Float               @default(0)
  totalWinnings Float               @default(0)
  lastBetAt     DateTime?
  lastLogin     DateTime?
  registeredAt  DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  agent         Agent?              @relation(fields: [agentId], references: [id])
  playerBets    PlayerBet[]
  transactions  PlayerTransaction[]

  @@index([username])
  @@index([agentId])
  @@index([status])
  @@index([balance])
  @@index([lastBetAt])
  @@map("dashboard_players")
}

model PlayerBet {
  id           String          @id @default(cuid())
  playerId     String
  betType      String
  amount       Float
  odds         Float
  potentialWin Float
  status       String          @default("pending")
  placedAt     DateTime        @default(now())
  settledAt    DateTime?
  player       DashboardPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([status])
  @@index([placedAt])
  @@map("player_bets")
}

model PlayerTransaction {
  id            String          @id @default(cuid())
  playerId      String
  type          String
  amount        Float
  balanceBefore Float
  balanceAfter  Float
  reason        String?
  createdAt     DateTime        @default(now())
  player        DashboardPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([type])
  @@index([createdAt])
  @@map("player_transactions")
}

model AgentBalanceLog {
  id             String   @id @default(cuid())
  agentId        String
  playerId       String
  playerUsername String
  type           String
  amount         Float
  reason         String?
  createdAt      DateTime @default(now())
  agent          Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([playerId])
  @@index([createdAt])
  @@map("agent_balance_logs")
}

model AdminActivityLog {
  id          String    @id @default(cuid())
  adminUserId String
  action      String
  targetId    String?
  targetType  String?
  details     Json?
  ipAddress   String?
  createdAt   DateTime  @default(now())
  resource    String?
  resourceId  String?
  admin       AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_activity_logs")
}

model OddsConfiguration {
  id                 String              @id @default(cuid())
  isActive           Boolean             @default(true)
  lastModified       DateTime            @default(now())
  modifiedBy         String
  spreadMargin       Float               @default(0.045)
  moneylineMargin    Float               @default(0.05)
  totalMargin        Float               @default(0.045)
  playerPropsMargin  Float               @default(0.08)
  gamePropsMargin    Float               @default(0.08)
  roundingMethod     String              @default("nearest10")
  minOdds            Int                 @default(-10000)
  maxOdds            Int                 @default(10000)
  leagueOverrides    Json?
  liveGameMultiplier Float               @default(1.0)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  changeHistory      OddsConfigHistory[]
  modifiedByAdmin    AdminUser           @relation(fields: [modifiedBy], references: [id])

  @@index([isActive])
  @@index([lastModified])
  @@map("odds_configuration")
}

model OddsConfigHistory {
  id             String            @id @default(cuid())
  configId       String
  adminUserId    String
  changedFields  Json
  previousValues Json
  newValues      Json
  reason         String?
  ipAddress      String?
  createdAt      DateTime          @default(now())
  admin          AdminUser         @relation(fields: [adminUserId], references: [id])
  config         OddsConfiguration @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([adminUserId])
  @@index([createdAt])
  @@map("odds_config_history")
}
